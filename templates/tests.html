{% extends 'base.html' %}
{% block extra-head %}
<script type="text/javascript">
var feeds = [
	"http://blogs.itemis.de/?showfeed=1",
	"http://www.heikobehrens.net/feed/"
	];
	
var queue = $({});

function validate(url, callback) {
	queue.queue('tests', function(next) {
		callback({"result":"pending"});
		$.get("{%url views.validate %}", {"url":url}, function(data){
			callback(data);
			// TODO if not cancelled
			next();
		});
	});
}

function validateRow(idx) {
	var row = $('#tests table tbody tr')[idx];
	var fillcellFunc = function(cellclass) {
		var cell = $($(row).find("."+cellclass)[0]);
		//console.log(cell);
		return function(data) {
			cell.text(data.result);
		}
	}
	
	var requestValidation = function(url, clazz) {
		var func = fillcellFunc(clazz);
		func({"result":"notyet"});
		validate(url, func);
	}
	
	var urlFeed = feeds[idx];
	var urlRss = "http://{{request.META.HTTP_HOST}}{% url views.sanitize %}?format=rss&url=" + encodeURI(urlFeed);
	var urlAtom = "http://{{request.META.HTTP_HOST}}{% url views.sanitize %}?format=atom&url=" + encodeURI(urlFeed);
	
	requestValidation(urlFeed, "result_origin");
	requestValidation(urlRss, "result_rss");
	requestValidation(urlAtom, "result_atom");
}

function runtests() {
	$('#runtests').attr('disabled', 'disabled');
	queue.queue("tests", function(next){
		$('#runtests').removeAttr('disabled');
		next();
	});
	queue.dequeue('tests');

// 	var urlFeed = feeds[1];
// 	var url = "http://{{request.META.HTTP_HOST}}{% url views.sanitize %}?format=rss&url=" + escape(urlFeed);
// 	//url = urlFeed;
// 	$.get("{%url views.validate %}", {"url":url}, function(data){
// //	$.get(url, {}, function(data){
// 		console.log(data);
// 	});
}
	
$(document).ready(function(){
	for(var i=0; i<feeds.length;i++) {
		var feed = feeds[i];
		$('#tests table tbody').append('<tr><td class="url">'+feed+'</td><td class="result_origin"></td><td class="result_rss"></td><td class="result_atom"></td>');
	}
	
	for(var i=0;i<feeds.length;i++) {
		validateRow(i);
	}
	
})
</script>
{% endblock %}
{% block content %}
<div id="tests">
	<table border=1>
		<thead>
			<tr>
				<th class="url">URL</th>
				<th class="result_origin">Original</th>
				<th class="result_rss">Sanitized RSS</th>
				<th class="result_atom">Sanitized ATOM</th>
			</tr>
			<tbody>
			</tbody>
		</thead>	
	</table>
	<input id="runtests" type="button" value="Run tests" onclick="runtests()" />
</div>	
{% endblock %}
